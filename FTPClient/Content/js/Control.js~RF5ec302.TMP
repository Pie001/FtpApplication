'use strict';

$(function() {
    $(document).bind("contextmenu", function(e) {
        return false;
    });

    _ftpControlBlock.init();
    _hostOptionModal.init();
    _filterServerModal.init();
    _makeDirectoryModal.init();
    _openServerModal.init();
    _changeResourceNameModal.init();
    _ftpControlBlock.operationLogBlock.log.scollTop();
});

// ============== ホスト関連メニュー ==============

var _hostOptionModal = {
    $me: null,
    init: function() {
        this.$me = $('#modal_host_option');
    },
    show: function() {
        this.$me.modal('show');
    }
}

var _filterServerModal = {
    $me: null,
    init: function() {
        this.$me = $('#modal_server_filter');
        this.form.init();
        this.filterPattern.init();
        this.btnOK.init();
        this.btnReset.init();
        this.title.init();
    },
    title: {
        $me: null,
        init: function() {
            this.$me = _filterServerModal.$me.find('div.modal-header h4.title');
        }
    },
    form: {
        $me: null,
        init: function() {
            this.$me = $('#form_server_filter');
        },
        getSerializeArray: function() {
            return this.$me.serializeArray();
        },
        isValid: function() {
            return this.$me.validate().form();
        }
    },
    filterPattern: {
        $me: null,
        init: function() {
            this.$me = $('#FilterPattern');
        }
    },
    show: function() {
        var env = '';
        if (_ftpControlBlock.server.selectedServer == 'local') {
            env = 'ローカル';
        } else {
            env = 'リモート';
        }

        _filterServerModal.title.$me.empty();
        _filterServerModal.title.$me.prepend('<i class="icon-filter-1"></i> フィルター(' + env + ')');

        this.$me.modal('show');
    },
    hide: function() {
        this.$me.modal('hide');
    },
    btnOK: {
        $me: null,
        init: function() {
            this.$me = $('#btn_filter_submit');
            this.click();
        },
        click: function() {
            this.$me.click(function(event) {
                if (_filterServerModal.form.isValid()) {
                    var selected = _ftpControlBlock.server.selectedServer;

                    if (selected != null) {
                        var divId = '';
                        if (selected == 'local') {
                            divId = '#localServerList';
                        } else {
                            divId = '#remoteServerList';
                        }

                        $.get('/BGFTP/ViewServerInfo?path=*&env=' + selected + '&filterPattern=' + _filterServerModal.filterPattern.$me.val(), function(data) {
                            $(divId).replaceWith(data);
                            if (divId == '#localServerList') {
                                _ftpControlBlock.server.localServer.init();
                            } else {
                                _ftpControlBlock.server.remoteServer.init();
                            }
                        });
                    }

                    _filterServerModal.hide();
                    _filterServerModal.filterPattern.$me.val('');

                    _ftpControlBlock.operationLogBlock.reset();
                }
                return false;
            });
        }
    },
    btnReset: {
        $me: null,
        init: function() {
            this.$me = $('#btn_filter_reset');
            this.click();
        },
        click: function() {
            this.$me.click(function(event) {
                if (_ftpControlBlock.server.selectedServer != null) {
                    _ftpControlBlock.server.allReset();
                }
                _filterServerModal.hide();

                return false;
            });
        }
    }
}

var _makeDirectoryModal = {
    $me: null,
    init: function() {
        this.$me = $('#modal_make_directory');
        this.form.init();
        this.directoryName.init();
        this.btnOK.init();
        this.title.init();
    },
    title: {
        $me: null,
        init: function() {
            this.$me = _makeDirectoryModal.$me.find('div.modal-header h4.title');
        }
    },
    form: {
        $me: null,
        init: function() {
            this.$me = $('#form_make_directory');
        },
        getSerializeArray: function() {
            return this.$me.serializeArray();
        },
        isValid: function() {
            return this.$me.validate().form();
        }
    },
    directoryName: {
        $me: null,
        init: function() {
            this.$me = $('#DirectoryName');
        }
    },
    btnOK: {
        $me: null,
        init: function() {
            this.$me = $('#btn_make_directory_submit');
            this.click();
        },
        click: function() {
            this.$me.click(function(event) {
                if (_makeDirectoryModal.form.isValid()) {
                    var param = _makeDirectoryModal.form.getSerializeArray();
                    var selected = _ftpControlBlock.server.selectedServer;
                    param.push({ name: 'env', value: selected });

                    _ajax.call('POST', '/BGFTP/MakeDirectory', param, function(response) {
                        if (response != null && response.Result == 'success') {
                            _ftpControlBlock.server.reset(selected);

                            _makeDirectoryModal.hide();
                            _makeDirectoryModal.directoryName.$me.val('');
                        }
                    }, true);

                    _ftpControlBlock.operationLogBlock.reset();
                }
                return false;
            });
        }
    },
    show: function() {
        var env = '';
        if (_ftpControlBlock.server.selectedServer == 'local') {
            env = 'ローカル';
        } else {
            env = 'リモート';
        }
        _makeDirectoryModal.title.$me.empty();
        _makeDirectoryModal.title.$me.prepend('<i class="icon-folder-add"></i> ディレクトリ作成(' + env + ')');

        this.$me.modal('show');
    },
    hide: function() {
        this.$me.modal('hide');
    }
}

var _changeResourceNameModal = {
    $me: null,
    beforeName: null,
    isDir: false,
    init: function() {
        this.$me = $('#modal_change_resource_name');
        this.form.init();
        this.newName.init();
        this.btnOK.init();
        this.title.init();
        this.currentFileInfo.init();
    },
    title: {
        $me: null,
        init: function() {
            this.$me = _changeResourceNameModal.$me.find('div.modal-header h4.title');
        }
    },
    currentFileInfo: {
        $me: null,
        init: function() {
            this.$me = _changeResourceNameModal.$me.find('div.modal-body p.current-file-info');
        }
    },
    form: {
        $me: null,
        init: function() {
            this.$me = $('#form_change_resource_name');
        },
        getSerializeArray: function() {
            return this.$me.serializeArray();
        },
        isValid: function() {
            return this.$me.validate().form();
        }
    },
    newName: {
        $me: null,
        init: function() {
            this.$me = $('#NewName');
        }
    },
    show: function() {
        _changeResourceNameModal.title.$me.empty();
        var env = '';
        var beforeName = '';
        var isDir = false;

        var selected = _ftpControlBlock.server.selectedServer;
        if (selected == 'local') {
            env = 'ローカル';
        } else {
            env = 'リモート';
        }

        if (selected == 'local') {
            $.each(_ftpControlBlock.server.localServer.list.$me.find('li.ui-selecting, li.ui-selected'), function(index, element) {
                beforeName = $(element).attr('data-fileid');
                if ($(element).find('i').hasClass('icon-folder-1')) {
                    isDir = true;
                }
            });
        } else {
            $.each(_ftpControlBlock.server.remoteServer.list.$me.find('li.ui-selecting, li.ui-selected'), function(index, element) {
                beforeName = $(element).attr('data-fileid');
                if ($(element).find('i').hasClass('icon-folder-1')) {
                    isDir = true;
                }
            });
        }

        if (beforeName != '') {
            _changeResourceNameModal.title.$me.empty();
            _changeResourceNameModal.title.$me.prepend('<i class="icon-tags"></i> 名前変更(' + env + ')');
            _changeResourceNameModal.currentFileInfo.$me.empty();
            _changeResourceNameModal.currentFileInfo.$me.prepend('[' + (isDir ? 'フォルダ' : 'ファイル') + '] ' + beforeName);

            _changeResourceNameModal.beforeName = beforeName;
            _changeResourceNameModal.isDir = isDir;

            _changeResourceNameModal.newName.$me.val('');

            this.$me.modal('show');
        } else {
            alert('名前を変更するファイルが存在しません。');
        }
    },
    hide: function() {
        this.$me.modal('hide');
    },
    btnOK: {
        $me: null,
        init: function() {
            this.$me = $('#btn_change_resource_name_submit');
            this.click();
        },
        click: function() {
            this.$me.click(function() {
                if (_changeResourceNameModal.form.isValid()) {
                    var selected = _ftpControlBlock.server.selectedServer;

                    if (_changeResourceNameModal.beforeName != '') {
                        var param = _changeResourceNameModal.form.getSerializeArray();
                        param.push({ name: 'env', value: _ftpControlBlock.server.selectedServer });
                        param.push({ name: 'isDir', value: _changeResourceNameModal.isDir });
                        param.push({ name: 'beforeName', value: _changeResourceNameModal.beforeName });

                        _ajax.call('POST', '/BGFTP/ChangeResourceName', param, function(response) {
                            if (response != null && response.Result == 'success') {
                                _ftpControlBlock.server.reset(selected);
                            }
                        }, true);
                        _changeResourceNameModal.hide();

                        _ftpControlBlock.operationLogBlock.reset();
                    } else {
                        alert('名前を変更するファイルを選択してください！');
                        _changeResourceNameModal.hide();
                    }
                }

                return false;
            });
        }
    }
}

var _openServerModal = {
    $me: null,
    init: function() {
        this.$me = $('#modal_open_server');
        this.form.init();
        this.path.init();
        this.btnOK.init();
        this.title.init();
    },
    title: {
        $me: null,
        init: function() {
            this.$me = _openServerModal.$me.find('div.modal-header h4.title');
        }
    },
    form: {
        $me: null,
        init: function() {
            this.$me = $('#form_open_server');
        },
        getSerializeArray: function() {
            return this.$me.serializeArray();
        },
        isValid: function() {
            return this.$me.validate().form();
        }
    },
    path: {
        $me: null,
        init: function() {
            this.$me = $('#Path');
        }
    },
    btnOK: {
        $me: null,
        init: function() {
            this.$me = $('#btn_open_server_submit');
            this.click();
        },
        click: function() {
            this.$me.click(function(event) {
                if (_openServerModal.form.isValid()) {
                    var openPath = _openServerModal.path.$me.val();
                    if (_ftpControlBlock.server.selectedServer == 'local') {
                        if (openPath.lastIndexOf('\\') > -1) {
                            $.get('/BGFTP/ViewServerInfo?path=' + openPath + '&env=local', function(data) {
                                _ftpControlBlock.server.localServer.$me.replaceWith(data);
                                _ftpControlBlock.server.localServer.init();
                                _ftpControlBlock.server.selectedServer = 'local';
                            });
                        }
                    } else {
                        if (openPath.lastIndexOf('/') > -1) {
                            $.get('/BGFTP/ViewServerInfo?path=' + openPath + '&env=remote', function(data) {
                                _ftpControlBlock.server.remoteServer.$me.replaceWith(data);
                                _ftpControlBlock.server.remoteServer.init();
                                _ftpControlBlock.server.selectedServer = 'remote';
                            });
                        }
                    }
                    _openServerModal.hide();
                }
                return false;
            });
        }
    },
    show: function() {
        var env = '';
        if (_ftpControlBlock.server.selectedServer == 'local') {
            env = 'ローカル';
            _openServerModal.path.$me.val(_ftpControlBlock.server.localServer.path.$me.find('option:selected').text());
        } else {
            env = 'リモート';
            _openServerModal.path.$me.val(_ftpControlBlock.server.remoteServer.path.$me.val());
        }
        _openServerModal.title.$me.empty();
        _openServerModal.title.$me.prepend('<i class="icon-folder-add"></i> サーバー移動(' + env + ')');

        this.$me.modal('show');
    },
    hide: function() {
        this.$me.modal('hide');
    }
}

var _ftpControlBlock = {
    $me: null,
    init: function() {
        this.$me = $('.ftp-control');
        this.btnBackward.init();
        this.btnFilterDirectory.init();
        this.btnRefresh.init();
        this.btnResourceRemove.init();
        this.btnChangeResourceName.init();
        this.btnMakeDirectory.init();
        this.server.init();
        this.form.init();
        this.operationLogBlock.init();
        this.hostMenuBlock.init();
    },
    form: {
        $me: null,
        init: function() {
            this.$me = $('#form_ftp_control');
        },
        getSerializeArray: function() {
            return this.$me.serializeArray();
        },
        isValid: function() {
            return this.$me.validate().form();
        }
    },
    hostMenuBlock: {
        $me: null,
        init: function() {
            this.$me = $('.host-control');
            this.hostList.init();
            this.btnHostOption.init();
            this.btnHostConnect.init();
            this.btnHostDisconnect.init();
        },
        reset: function() {
            $.get('/BGHost/ViewHostList', function(data) {
                _ftpControlBlock.hostMenuBlock.$me.replaceWith(data);
                _ftpControlBlock.hostMenuBlock.init();
            });
        },
        hostList: {
            $me: null,
            init: function() {
                this.$me = $('select[name="host_list"]');
            }
        },
        btnHostOption: {
            $me: null,
            init: function() {
                this.$me = $('#btn_host_option');
                this.click();
            },
            click: function() {
                this.$me.click(function() {
                    _hostOptionModal.show();
                });
            }
        },
        btnHostConnect: {
            $me: null,
            init: function() {
                this.$me = $('#btn_host_connect');
                this.click();
            },
            click: function() {
                this.$me.click(function() {
                    _ftpControlBlock.hostMenuBlock.hostList.$me.find('option:selected').each(function() {
                        var param = _connectionConfig.form.getSerializeArray();
                        param.push({ name: 'selectHostId', value: $(this).val() });
                        _ajax.call('POST', '/BGFTP/Connect', param, function(response) {
                            if (response != null && response.Result == 'success') {
                                window.location.href = '/FTP/';
                            }
                        }, true);
                    });
                });
            }
        },
        btnHostDisconnect: {
            $me: null,
            init: function() {
                this.$me = $('#btn_host_disconnect');
                this.click();
            },
            click: function() {
                this.$me.click(function() {
                    var param = _ftpControlBlock.form.getSerializeArray();
                    _ajax.call('POST', '/BGFTP/Disconnect', param, function(response) {
                        if (response != null && response.Result == 'success') {
                            window.location.href = '/';
                        }
                    }, true);
                });
            }
        }
    },
    btnBackward: {
        $me: null,
        init: function() {
            this.$me = $('#btn_backward');
            this.click();
        },
        click: function() {
            this.$me.click(function() {
                if (_ftpControlBlock.server.selectedServer != null) {
                    var divId = '';
                    var currentPath = '';
                    var isViewServer = false;
                    if (_ftpControlBlock.server.selectedServer == 'local') {
                        divId = '#localServerList';

                        _ftpControlBlock.server.localServer.path.$me.find('option:selected').each(function() {
                            currentPath = $(this).text()
                        });

                        if (currentPath.indexOf('\\') != currentPath.length) {
                            isViewServer = true;
                        }
                    } else {
                        divId = '#remoteServerList';
                        if (_ftpControlBlock.server.remoteServer.path.$me.val().indexOf('/') > -1) {
                            isViewServer = true;
                        }
                    }

                    if (isViewServer) {
                        $.get('/BGFTP/ViewServerInfo?path=..&env=' + _ftpControlBlock.server.selectedServer, function(data) {
                            $(divId).replaceWith(data);
                            if (divId == '#localServerList') {
                                _ftpControlBlock.server.localServer.init();
                            } else {
                                _ftpControlBlock.server.remoteServer.init();
                            }
                        });
                    }
                }
            });
        }
    },
    btnFilterDirectory: {
        $me: null,
        init: function() {
            this.$me = $('#btn_filter');
            this.click();
        },
        click: function() {
            this.$me.click(function() {
                _filterServerModal.show();
            });
        }
    },
    btnRefresh: {
        $me: null,
        init: function() {
            this.$me = $('#btn_refresh');
            this.click();
        },
        click: function() {
            this.$me.click(function() {
                if (_ftpControlBlock.server.selectedServer != null) {
                    _ftpControlBlock.server.allReset();
                }
            });
        }
    },
    btnResourceRemove: {
        $me: null,
        init: function() {
            this.$me = $('#btn_resource_remove');
            this.click();
        },
        click: function() {
            this.$me.click(function() {
                var isRemove = false;
                var selected = _ftpControlBlock.server.selectedServer;
                var fileName = '';
                var isDir = false;
                var fileList = [];

                if (selected == 'local') {
                    $.each(_ftpControlBlock.server.localServer.list.$me.find('li.ui-selecting, li.ui-selected'), function(index, element) {
                        fileName = $(element).attr('data-fileid');
                        if (fileName != '..') {
                            if ($(element).find('i').hasClass('icon-folder-1')) {
                                isDir = true;
                            } else {
                                isDir = false;
                            }
                            var data = [fileName, isDir];
                            fileList.push(data);
                            isRemove = true;
                        }
                    });
                } else {
                    $.each(_ftpControlBlock.server.remoteServer.list.$me.find('li.ui-selecting, li.ui-selected'), function(index, element) {
                        fileName = $(element).attr('data-fileid');
                        if (fileName != '..') {
                            if ($(element).find('i').hasClass('icon-folder-1')) {
                                isDir = true;
                            } else {
                                isDir = false;
                            }
                            var data = [fileName, isDir];
                            fileList.push(data);
                            isRemove = true;
                        }
                    });
                }

                if (isRemove && confirm('ファイルを削除しますか？')) {
                    var param = _ftpControlBlock.form.getSerializeArray();
                    param.push({ name: 'env', value: selected });
                    param.push({ name: 'resList', value: fileList.join(':') });

                    _ajax.call('POST', '/BGFTP/RemoveResource', param, function(response) {
                        if (response != null && response.Result == 'success') {
                            _ftpControlBlock.server.reset(selected);
                        }
                    }, true);

                    _ftpControlBlock.operationLogBlock.reset();
                } else {
                    alert('削除するファイルが存在しません。');
                }
            });
        }
    },
    btnChangeResourceName: {
        $me: null,
        init: function() {
            this.$me = $('#btn_change_resource_name');
            this.click();
        },
        click: function() {
            this.$me.click(function() {
                _changeResourceNameModal.show();
            });
        }
    },
    btnMakeDirectory: {
        $me: null,
        init: function() {
            this.$me = $('#btn_make_directory');
            this.click();
        },
        click: function() {
            this.$me.click(function() {
                if (_makeDirectoryModal.directoryName.$me.hasClass('input-validation-error')) {
                    _makeDirectoryModal.directoryName.$me.removeClass('input-validation-error');
                    $('.field-validation-error span').remove();
                }
                _makeDirectoryModal.show();
            });
        }
    },
    server: {
        $me: null,
        selectedServer: 'local',
        init: function() {
            this.$me = $('.server');
            this.localServer.init();
            this.remoteServer.init();
        },
        allReset: function() {
            $.get('/BGFTP/ViewServerInfo?path=*', function(data) {
                _ftpControlBlock.server.$me.replaceWith(data);
                _ftpControlBlock.server.init();
                return false;
            });
        },
        reset: function(env) {
            $.get('/BGFTP/ViewServerInfo?path=*&env=' + env, function(data) {
                if (env == 'local') {
                    _ftpControlBlock.server.localServer.$me.replaceWith(data);
                    _ftpControlBlock.server.localServer.init();
                } else {
                    _ftpControlBlock.server.remoteServer.$me.replaceWith(data);
                    _ftpControlBlock.server.remoteServer.init();
                }
                return false;
            });
        },
        localServer: {
            $me: null,
            init: function() {
                this.$me = $('.local-server');
                this.btnOpenServer.init();
                this.path.init();
                this.list.init();
            },
            btnOpenServer: {
                $me: null,
                init: function() {
                    this.$me = $('#btn_open_local_server');
                    this.click();
                },
                click: function() {
                    this.$me.click(function() {
                        _ftpControlBlock.server.selectedServer = 'local';
                        if (_openServerModal.path.$me.hasClass('input-validation-error')) {
                            _openServerModal.path.$me.removeClass('input-validation-error');
                            $('.field-validation-error span').remove();
                        }
                        _openServerModal.show();
                    });
                }
            },
            path: {
                $me: null,
                $selected: null,
                init: function() {
                    this.$me = $('select[name="local_server_path"]');
                    this.change();
                },
                change: function() {
                    this.$me.change(function() {
                        _ftpControlBlock.server.localServer.path.$me.find('option:selected').each(function() {
                            $.get('/BGFTP/ViewServerInfo?path=' + $(this).text() + '&env=local', function(data) {
                                _ftpControlBlock.server.localServer.$me.replaceWith(data);
                                _ftpControlBlock.server.localServer.init();
                                _ftpControlBlock.server.selectedServer = 'local';
                            });
                        });
                    });
                }
            },
            list: {
                $me: null,
                init: function() {
                    this.$me = $('.local-server-list');
                    this.fileList.init();
                    this.setUI();
                    this.click();
                },
                fileList: {
                    $me: null,
                    init: function() {
                        this.$me = $('.local-file-list');
                    }
                },
                setUI: function() {
                    this.setSelectable();
                    this.setDraggable();
                    this.setDroppable();
                },
                setSelectable: function() {
                    this.$me.selectable({
                        filter: 'li.local-file-item, li.remote-file-item',
                        start: function(event, ui) {
                            _ftpControlBlock.server.selectedServer = 'local';
                        }
                    });
                },
                setDraggable: function() {
                    this.$me.find('li.local-file-item, li.remote-file-item').draggable({
                        helper: function() {
                            var selected = _ftpControlBlock.server.localServer.list.$me.find('li.ui-selected, li.ui-selecting');
                            var container = $('<div/>');
                            container.append(selected.clone().removeClass('ui-selected').removeClass('ui-selecting'));

                            _ftpControlBlock.server.selectedServer = 'local';

                            return container;
                        }
                    });
                },
                setDroppable: function() {
                    this.$me.droppable({
                        drop: function(ev, ui) {
                            var isTarget = false;

                            $.each(_ftpControlBlock.server.remoteServer.list.$me.find('li.ui-selected, li.ui-selecting'), function(index, element) {
                                isTarget = true;
                                return false;
                            });

                            if (isTarget) {
                                var isDownload = false;
                                var fileList = [];

                                $.each(_ftpControlBlock.server.remoteServer.list.$me.find('li.ui-selecting, li.ui-selected'), function(index, element) {
                                    var fileName = '';
                                    var isDir = false;
                                    fileName = $(element).attr('data-fileid');
                                    if (fileName != '..') {
                                        if ($(element).find('i').hasClass('icon-folder-1')) {
                                            isDir = true;
                                        } else {
                                            isDir = false;
                                        }
                                        var data = [fileName, isDir];
                                        fileList.push(data);
                                        isDownload = true;
                                    }
                                });

                                if (isDownload) {
                                    var param = _ftpControlBlock.form.getSerializeArray();
                                    param.push({ name: 'resList', value: fileList.join(':') });

                                    _ajax.call('POST', '/BGFTP/Download', param, function(response) {
                                        if (response != null && response.Result == 'success') {
                                            _ftpControlBlock.server.reset('local');
                                        }
                                    }, true);
                                }

                                _ftpControlBlock.operationLogBlock.reset();
                                _ftpControlBlock.server.remoteServer.list.$me.find('li').removeClass('ui-selected').removeClass('ui-selecting');
                            }
                        }
                    });
                },
                click: function() {
                    this.$me.find('li.local-file-item, li.remote-file-item').click(function(event) {
                        if (event.metaKey == false) {
                            _ftpControlBlock.server.localServer.list.$me.find('li').removeClass('ui-selected').removeClass('ui-selecting');
                            $(this).addClass('ui-selecting');
                        }
                        else {
                            if ($(this).hasClass('ui-selected')) {
                                $(this).removeClass('ui-selected');
                            }
                            else {
                                $(this).addClass('ui-selecting');
                            }
                        }
                        _ftpControlBlock.server.selectedServer = 'local';
                    });

                    this.$me.bind('contextmenu', function(e) {
                        alert('local :: 右クリック');
                        var parentOffset = $(this).parent().offset();
                        var relX = e.pageX - parentOffset.left;
                        var relY = e.pageY - parentOffset.top;
                        alert('relX : ' + e.pageX + ' / relY : ' + e.pageY);
                    });
                }
            }
        },
        remoteServer: {
            $me: null,
            init: function() {
                this.$me = $('.remote-server');
                this.btnOpenServer.init();
                this.path.init();
                this.list.init();
            },
            btnOpenServer: {
                $me: null,
                init: function() {
                    this.$me = $('#btn_open_remote_server');
                    this.click();
                },
                click: function() {
                    this.$me.click(function() {
                        _ftpControlBlock.server.selectedServer = 'remote';
                        if (_openServerModal.path.$me.hasClass('input-validation-error')) {
                            _openServerModal.path.$me.removeClass('input-validation-error');
                            $('.field-validation-error span').remove();
                        }
                        _openServerModal.show();
                    });
                }
            },
            path: {
                $me: null,
                init: function() {
                    this.$me = $('#RemoteServerPath');
                }
            },
            list: {
                $me: null,
                init: function() {
                    this.$me = $('.remote-server-list');
                    this.fileList.init();
                    this.setUI();
                    this.click();
                },
                fileList: {
                    $me: null,
                    init: function() {
                        this.$me = $('.remote-file-list');
                    }
                },
                setUI: function() {
                    this.setSelectable();
                    this.setDraggable();
                    this.setDroppable();
                },
                setSelectable: function() {
                    this.$me.selectable({
                        filter: 'li.local-file-item, li.remote-file-item',
                        start: function(event, ui) {
                            _ftpControlBlock.server.selectedServer = 'remote';
                        }
                    });
                },
                setDraggable: function() {
                    this.$me.find('li.remote-file-item, li.local-file-item').draggable({
                        helper: function() {
                            var selected = _ftpControlBlock.server.remoteServer.list.$me.find('li.ui-selected, li.ui-selecting');
                            var container = $('<div/>');
                            container.append(selected.clone().removeClass('ui-selected').removeClass('ui-selecting'));

                            _ftpControlBlock.server.selectedServer = 'remote';

                            return container;
                        },
                        revert: 'invaild',
                        cursor: 'move'
                    });
                },
                setDroppable: function() {
                    this.$me.droppable({
                        drop: function(ev, ui) {
                            var isTarget = false;
                            $.each(_ftpControlBlock.server.localServer.list.$me.find('li.ui-selected, li.ui-selecting'), function(index, element) {
                                //if ($(element).attr('data-isupload') == 'true') {
                                //    $(element).attr('data-isupload', false);
                                //    _ftpControlBlock.server.remoteServer.list.fileList.$me.append($(element).clone().removeClass('ui-selected').removeClass('ui-selecting'));
                                //}

                                isTarget = true;
                                return false;
                            });

                            if (isTarget) {
                                var isUpload = false;
                                var fileList = [];

                                $.each(_ftpControlBlock.server.localServer.list.$me.find('li.ui-selecting, li.ui-selected'), function(index, element) {
                                    var fileName = '';
                                    var isDir = false;
                                    fileName = $(element).attr('data-fileid');
                                    if (fileName != '..') {
                                        if ($(element).find('i').hasClass('icon-folder-1')) {
                                            isDir = true;
                                        } else {
                                            isDir = false;
                                        }
                                        var data = [fileName, isDir];
                                        fileList.push(data);
                                        isUpload = true;
                                    }
                                });

                                if (isUpload) {
                                    var param = _ftpControlBlock.form.getSerializeArray();
                                    param.push({ name: 'resList', value: fileList.join(':') });

                                    _ajax.call('POST', '/BGFTP/Upload', param, function(response) {
                                        if (response != null && response.Result == 'success') {
                                            _ftpControlBlock.server.reset('remote');
                                        }
                                    }, true);
                                }

                                _ftpControlBlock.operationLogBlock.reset();
                                _ftpControlBlock.server.localServer.list.$me.find('li').removeClass('ui-selected').removeClass('ui-selecting');
                            }

                            // 初期化
                            //_ftpControlBlock.server.remoteServer.list.setDraggable();
                            //_ftpControlBlock.server.remoteServer.list.click();
                            //_ftpControlBlock.server.remoteServer.list.fileList.$me.find('li.ui-draggable-dragging').remove();

                            return false;
                        }
                    });
                },
                click: function() {
                    this.$me.find('li.local-file-item, li.remote-file-item').click(function(event) {
                        if (event.metaKey == false) {
                            _ftpControlBlock.server.remoteServer.list.$me.find('li').removeClass('ui-selected').removeClass('ui-selecting');
                            $(this).addClass('ui-selecting');
                        }
                        else {
                            if ($(this).hasClass('ui-selected')) {
                                $(this).removeClass('ui-selected');
                            }
                            else {
                                $(this).addClass('ui-selecting');
                            }
                        }
                        _ftpControlBlock.server.selectedServer = 'remote';
                    });

                    this.$me.bind('contextmenu', function(e) {
                        alert('remote :: 右クリック');
                        var parentOffset = $(this).parent().offset();
                        var relX = e.pageX - parentOffset.left;
                        var relY = e.pageY - parentOffset.top;
                        alert('relX : ' + e.pageX + ' / relY : ' + e.pageY);

                    });
                }
            }
        }
    },
    operationLogBlock: {
        $me: null,
        init: function() {
            this.$me = $('.ftp-operation-log');
            this.btnDownloadLog.init();
            this.btnRemoveLog.init();
            this.log.init();
        },
        reset: function() {
            $.get('/BGFTP/ViewLog', function(data) {
                _ftpControlBlock.operationLogBlock.$me.replaceWith(data);
                _ftpControlBlock.operationLogBlock.init();
                _ftpControlBlock.operationLogBlock.log.scollTop();
            });
        },
        log: {
            $me: null,
            init: function() {
                this.$me = $('#OperationLog');
            },
            scollTop: function() {
                _ftpControlBlock.operationLogBlock.log.$me.animate({
                    scrollTop: _ftpControlBlock.operationLogBlock.log.$me[0].scrollHeight - _ftpControlBlock.operationLogBlock.log.$me.height()
                }, 400);
            }
        },
        btnDownloadLog: {
            $me: null,
            init: function() {
                this.$me = $('#btn_download_log');
                this.click();
            },
            click: function() {
                this.$me.click(function() {
                    _ajax.call('POST', '/BGFTP/DownloadLog', _ftpControlBlock.form.getSerializeArray(), function(response) {
                        if (response != null && response.Result == 'success') {
                            _ftpControlBlock.operationLogBlock.reset();
                        }
                    }, true);
                });
            }
        },
        btnRemoveLog: {
            $me: null,
            init: function() {
                this.$me = $('#btn_remove_log');
                this.click();
            },
            click: function() {
                this.$me.click(function() {
                    _ajax.call('POST', '/BGFTP/RemoveLog', _ftpControlBlock.form.getSerializeArray(), function(response) {
                        if (response != null && response.Result == 'success') {
                            _ftpControlBlock.operationLogBlock.reset();
                        }
                    }, true);
                });
            }
        }
    }
}

function setLocalServer(data) {
    _ftpControlBlock.server.localServer.$me.replaceWith(data.responseText);
    _ftpControlBlock.server.localServer.init();
}

function setRemoteServer(data) {
    _ftpControlBlock.server.remoteServer.$me.replaceWith(data.responseText);
    _ftpControlBlock.server.remoteServer.init();
}